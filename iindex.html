<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard ‚Äì Esta√ß√£o EMBC (Ao Vivo)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f5f5f5; color: #333; }
    h2 { text-align: center; margin-bottom: 40px; }
    .grafico-container { width: 80%; margin: 30px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h2>üìä Dashboard da Esta√ß√£o EMBC ‚Äì Atualiza√ß√£o Autom√°tica</h2>

  <div class="grafico-container">
    <h3>üå°Ô∏è Temperatura</h3>
    <canvas id="graficoTemp"></canvas>
  </div>

  <div class="grafico-container">
    <h3>üíß Umidade</h3>
    <canvas id="graficoUmid"></canvas>
  </div>

  <div class="grafico-container">
    <h3>üå¨Ô∏è Velocidade do Vento</h3>
    <canvas id="graficoVento"></canvas>
  </div>

  <div class="grafico-container">
    <h3>‚òÄÔ∏è Irradia√ß√£o Solar</h3>
    <canvas id="graficoIrrad"></canvas>
  </div>

  <div class="grafico-container">
    <h3>üåßÔ∏è Pluviometria</h3>
    <canvas id="graficoPluvio"></canvas>
  </div>

  <script>
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR7EQ0WDdVrrSvfpFU_AKc7NwNhJfQkKo2ndSxZ6Qxg1JDZm7ww9eJTUDjGaPSZS-BqxZXP3WJ8JLbO/pub?output=csv";

    let chartTemp, chartUmid, chartVento, chartIrrad, chartPluvio;

    async function carregarCSV() {
      const resposta = await fetch(url);
      const texto = await resposta.text();

      const linhas = texto.trim().split("\n").slice(1);
      const tempos = [];
      const temperaturas = [];
      const umidades = [];
      const ventos = [];
      const irradiacao = [];
      const pluviometria = [];

      linhas.forEach(linha => {
        const cols = linha.split(",");
        const data = cols[1]; // DATA
        const hora = cols[2]; // HORARIO
        const temp = parseFloat(cols[3]);
        const umid = parseFloat(cols[4]);
        const vento = parseFloat(cols[5]);
        const irrad = parseFloat(cols[6]);
        const pluvio = parseFloat(cols[7]);

        tempos.push(`${data} ${hora}`);
        temperaturas.push(!isNaN(temp) ? temp : null);
        umidades.push(!isNaN(umid) ? umid : null);
        ventos.push(!isNaN(vento) ? vento : null);
        irradiacao.push(!isNaN(irrad) ? irrad : null);
        pluviometria.push(!isNaN(pluvio) ? pluvio : null);
      });

      return { tempos, temperaturas, umidades, ventos, irradiacao, pluviometria };
    }

    function criarGrafico(ctx, label, dados, cor) {
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label,
            data: [],
            borderColor: cor,
            fill: false,
            tension: 0.4,
            pointRadius: 2,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: {
              grid: { color: '#eee' },
              ticks: { maxRotation: 45, minRotation: 45 }
            },
            y: { grid: { color: '#eee' } }
          }
        }
      });
    }

    async function atualizarGraficos() {
      const { tempos, temperaturas, umidades, ventos, irradiacao, pluviometria } = await carregarCSV();

      chartTemp.data.labels = tempos;
      chartTemp.data.datasets[0].data = temperaturas;
      chartTemp.update();

      chartUmid.data.labels = tempos;
      chartUmid.data.datasets[0].data = umidades;
      chartUmid.update();

      chartVento.data.labels = tempos;
      chartVento.data.datasets[0].data = ventos;
      chartVento.update();

      chartIrrad.data.labels = tempos;
      chartIrrad.data.datasets[0].data = irradiacao;
      chartIrrad.update();

      chartPluvio.data.labels = tempos;
      chartPluvio.data.datasets[0].data = pluviometria;
      chartPluvio.update();
    }

    async function iniciarDashboard() {
      chartTemp = criarGrafico(document.getElementById("graficoTemp"), "Temperatura (¬∞C)", [], "rgba(255,99,132,1)");
      chartUmid = criarGrafico(document.getElementById("graficoUmid"), "Umidade (%)", [], "rgba(54,162,235,1)");
      chartVento = criarGrafico(document.getElementById("graficoVento"), "Velocidade do Vento (m/s)", [], "rgba(75,192,192,1)");
      chartIrrad = criarGrafico(document.getElementById("graficoIrrad"), "Irradia√ß√£o Solar", [], "rgba(255,159,64,1)");
      chartPluvio = criarGrafico(document.getElementById("graficoPluvio"), "Pluviometria", [], "rgba(153,102,255,1)");

      await atualizarGraficos();
      setInterval(atualizarGraficos, 60000); // Atualiza a cada 60 segundos
    }

    iniciarDashboard();
  </script>
</body>
</html>
